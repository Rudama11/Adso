{% load static %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura</title>
    <link rel="stylesheet" href="{% static 'lib/venta/styles.css' %}">
    <link rel="stylesheet" href="{% static 'lib/jquery/css/jquery-ui.css' %}">
    <link rel="stylesheet" href="{% static 'lib/select2/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'lib/adminlte-3.0.4/plugins/font-awesome-5.11.1/css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'lib/adminlte-3.0.4/css/adminlte.min.css' %}">
</head>

<body>
    <div class="invoice-container">
        <header>
            <div class="invoice-info">
                <img src="{% static 'img/logo.jpg' %}" alt="Logo de la Empresa" class="logo">
                <h2>Datos Factura</h2>
                <div class="invoice-details">
                    <p><strong>Fecha Emisión:</strong> <input type="date" id="fecha_emision"></p>
                    <p><strong>Fecha Vencimiento:</strong> <input type="date" id="fecha_vencimiento"></p>
                    <p><strong>Número de Factura:</strong> <input type="text" id="num_factura"></p>
                </div>
            </div>
            <p></p>
            <div class="company-info">
                <div class="company-details">
                    <h2>Empresa (Emisor)</h2>
                    <p><strong>Nombre:</strong> Conaldex-Boyaca</p>
                    <p><strong>NIT:</strong> 91068006-8</p>
                    <p><strong>Dirección:</strong> Calle 7 # 14-65</p>
                    <p><strong>Correo:</strong> conaldexboyaca@gmail.com</p>
                    <p><strong>Celular:</strong> +57 3124352596</p>
                </div>
            </div>
        </header>
        <section class="client-info">
            <div class="client-data">
                <h2>Cliente (Remitente)</h2>
                <div class="client-details">
                    <p><strong>Número documento:</strong>
                        <select class="form-control col-md-6" name="cliente" id="cliente_select">
                            <option value="" hidden>Seleccione un cliente</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.numero_documento }} - {{ cliente.nombres|default:cliente.razon_social }}</option>
                            {% endfor %}
                        </select>
                    </p>
                    <p><strong>Nombres/Razón Social:</strong> <input type="text" id="cliente_nombre" placeholder="Nombres/Razón Social"></p>
                    <p><strong>Dirección residencia:</strong> <input type="text" id="cliente_direccion" placeholder="Dirección"></p>
                    <p><strong>Correo:</strong> <input type="email" id="cliente_mail" placeholder="Correo"></p>
                    <p><strong>Celular:</strong> <input type="text" id="cliente_telefono" placeholder="Celular"></p>
                </div>
            </div>
        </section>

        <section class="invoice-details">
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Iva (%)</th>
                        <th>Total</th>
                        <th class="acciones">Acciones</th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <tr>
                        <td>1</td>
                        <td>
                            <select class="form-control producto_select" name="producto">
                                <option value="" hidden>Seleccione un producto</option>
                                {% for producto in productos %}
                                    <option value="{{ producto.id }}">{{ producto.nombre }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="number" name="cantidad" class="form-control cantidad" value="1" min="1"></td>
                        <td><input type="text" name="precio_unitario" class="form-control precio_unitario" readonly></td>
                        <td><input type="number" name="iva" class="form-control iva" value="0" min="0" step="0.01"></td>
                        <td><input type="text" name="total" class="form-control total" readonly></td>
                        <td><button type="button" class="btn btn-danger eliminar-fila">Eliminar</button></td>
                    </tr>
                </tbody>                               
            </table>
            <button type="button" id="add-item">Añadir Producto</button>
        </section>

        <section class="invoice-totals">
            <div class="totals">
                <h3>Totales</h3>
                <p><strong>Subtotal:</strong> <span id="subtotal">0.0</span> $ COP</p>
                <p><strong>Descuento:</strong> <input type="number" id="descuento" value="0" min="0" step="1"> %</p>
                <p><strong>Subtotal - Dto:</strong> <span id="subtotal_dto">0.0</span> $ COP</p>
                <p><strong>Total IVA:</strong> <span id="total_iva">0.0</span> $ COP</p>
                <p><strong>TOTAL:</strong> <span id="total">0.0</span> $ COP</p>
            </div>
        </section>

        <div class="footer-buttons">
            <button type="button" id="print-invoice">Imprimir factura</button>
            <a href="{{ listar_url }}" id="cancel">Cancelar factura</a>
        </div>
    </div>

    <script src="{% static 'lib/jquery/js/jquery-3.7.1.js' %}"></script>
    <script src="{% static 'lib/select2/js/select2.min.js' %}"></script>
    <script src="{% static 'lib/venta/script.js' %}"></script>

    <script>
        $(document).ready(function() {
        $('#cliente_select').on('change', function() {
            var clienteId = $(this).val();
            if (clienteId) {
                $.ajax({
                    url: '{% url "app:obtener_datos_cliente" %}',  // Asegúrate de que el nombre de la URL sea correcto
                    data: {
                        'cliente_id': clienteId
                    },
                    success: function(data) {
                        $('#cliente_nombre').val(data.nombre);
                        $('#cliente_direccion').val(data.direccion);
                        $('#cliente_mail').val(data.correo);
                        $('#cliente_telefono').val(data.telefono);
                    },
                    error: function() {
                        alert('Error al obtener los datos del cliente.');
                    }
                });
            }
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('.producto_select').on('change', function() {
            var productoId = $(this).val();
            var $row = $(this).closest('tr');
    
            if (productoId) {
                $.ajax({
                    url: '{% url "app:obtener_datos_producto" %}',
                    data: {
                        'producto_id': productoId
                    },
                    success: function(data) {
                        $row.find('.precio_unitario').val(data.precio);
                        // Puedes añadir cualquier otro campo que necesites actualizar aquí
                    },
                    error: function() {
                        alert('Error al obtener los datos del producto.');
                    }
                });
            }
        });
    });
</script>
</body>
</html>