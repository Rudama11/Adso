{% load static %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura</title>
    <link rel="stylesheet" href="{% static 'css/venta/styles.css' %}">
    <link rel="stylesheet" href="{% static 'lib/jquery/css/jquery-ui.css' %}">
    <link rel="stylesheet" href="{% static 'lib/select2/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'lib/adminlte-3.0.4/plugins/font-awesome-5.11.1/css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'lib/adminlte-3.0.4/css/adminlte.min.css' %}">
</head>

<body>
    <div class="invoice-container">
        <header>
            <div class="invoice-info">
                <img src="{% static 'img/logo.jpg' %}" alt="Logo de la Empresa" class="logo">
                <h2>Datos Factura</h2>
                <div class="invoice-details">
                    <p><strong>Fecha Emisión:</strong> <input type="date" id="fecha_emision"></p>
                    <p><strong>Fecha Vencimiento:</strong> <input type="date" id="fecha_vencimiento"></p>
                    <p><strong>Número de Factura:</strong> <input type="text" id="num_factura"></p>
                </div>
            </div>
            <div class="company-info">
                <div class="company-details">
                    <h2>Empresa (Emisor)</h2>
                    <p><strong>Nombre:</strong> Conaldex-Boyaca</p>
                    <p><strong>NIT:</strong> 91068006-8</p>
                    <p><strong>Dirección:</strong> Calle 7 # 14-65</p>
                    <p><strong>Correo:</strong> conaldexboyaca@gmail.com</p>
                    <p><strong>Celular:</strong> +57 3124352596</p>
                </div>
            </div>
        </header>
        <section class="client-info">
            <div class="client-data">
                <h2>Cliente (Remitente)</h2>
                <div class="client-details">
                    <p><strong>Número documento:</strong>
                        <select class="form-control col-md-6" name="cliente" id="cliente_select">
                            <option value="" hidden>Seleccione un cliente</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.numero_documento }} - {{ cliente.nombres|default:cliente.razon_social }}</option>
                            {% endfor %}
                        </select>
                    </p>
                    <p><strong>Nombres/Razón Social:</strong> <input type="text" id="cliente_nombre" placeholder="Nombres/Razón Social"></p>
                    <p><strong>Dirección residencia:</strong> <input type="text" id="cliente_direccion" placeholder="Dirección"></p>
                    <p><strong>Correo:</strong> <input type="email" id="cliente_mail" placeholder="Correo"></p>
                    <p><strong>Celular:</strong> <input type="text" id="cliente_telefono" placeholder="Celular"></p>
                </div>
            </div>
        </section>

        <section class="invoice-details">
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Iva (%)</th>
                        <th>Total</th>
                        <th class="acciones">Acciones</th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <!-- Se eliminará la fila predeterminada -->
                </tbody>
            </table>
            <button type="button" id="add-item">Añadir Producto</button>
        </section>

        <section class="invoice-totals">
            <div class="totals">
                <h3>Totales</h3>
                <p><strong>Subtotal:</strong> <span id="subtotal">0.0</span> $ COP</p>
                <p><strong>Descuento:</strong> <input type="number" id="descuento" value="0" min="0" step="1"> %</p>
                <p><strong>Subtotal - Dto:</strong> <span id="subtotal_dto">0.0</span> $ COP</p>
                <p><strong>Total IVA:</strong> <span id="total_iva">0.0</span> $ COP</p>
                <p><strong>TOTAL:</strong> <span id="total">0.0</span> $ COP</p>
            </div>
        </section>

        <div class="footer-buttons">
            <button type="button" id="print-invoice">Imprimir factura</button>
            <a href="{{ listar_url }}" id="cancel">Cancelar factura</a>
        </div>
    </div>

    <script src="{% static 'lib/jquery/js/jquery-3.7.1.js' %}"></script>
    <script src="{% static 'lib/select2/js/select2.min.js' %}"></script>

    <script>
        $(document).ready(function() {
            const $clienteSelect = $('#cliente_select');
            const $clienteNombre = $('#cliente_nombre');
            const $clienteDireccion = $('#cliente_direccion');
            const $clienteMail = $('#cliente_mail');
            const $clienteTelefono = $('#cliente_telefono');
            const $invoiceItems = $('#invoice-items');
            const $subtotal = $('#subtotal');
            const $descuento = $('#descuento');
            const $subtotalDto = $('#subtotal_dto');
            const $totalIva = $('#total_iva');
            const $total = $('#total');

            function updateClientData(clienteId) {
                $.ajax({
                    url: '{% url "app:obtener_datos_cliente" %}',
                    data: { 'cliente_id': clienteId },
                    success: function(data) {
                        $clienteNombre.val(data.nombre);
                        $clienteDireccion.val(data.direccion);
                        $clienteMail.val(data.correo);
                        $clienteTelefono.val(data.telefono);
                    },
                    error: function() {
                        alert('Error al obtener los datos del cliente.');
                    }
                });
            }

            function updateTotals() {
                let subtotal = 0;
                let totalIva = 0;

                $invoiceItems.find('tr').each(function() {
                    const $row = $(this);
                    const cantidad = parseFloat($row.find(".cantidad").val()) || 0;
                    const precioUnitario = parseFloat($row.find(".precio-unitario").val()) || 0;
                    const iva = parseFloat($row.find(".iva").val()) || 0;

                    const totalSinIva = cantidad * precioUnitario;
                    const totalConIva = totalSinIva * (1 + iva / 100);

                    $row.find(".total").text(totalConIva.toFixed(2));

                    subtotal += totalSinIva;
                    totalIva += totalSinIva * (iva / 100);
                });

                const descuento = parseFloat($descuento.val()) / 100 || 0;
                const subtotalDto = subtotal * (1 - descuento);
                $subtotal.text(subtotal.toFixed(2));
                $subtotalDto.text(subtotalDto.toFixed(2));
                $totalIva.text(totalIva.toFixed(2));
                $total.text((subtotalDto + totalIva).toFixed(2));
            }

            function updateItemNumbers() {
                $invoiceItems.find('tr').each(function(index) {
                    $(this).find("td:first-child").text(index + 1);
                });
            }

            function updateProductOptions() {
                const selectedProducts = $invoiceItems.find(".producto_select").map(function() {
                    return $(this).val();
                }).get();

                $(".producto_select option").each(function() {
                    const $option = $(this);
                    $option.toggle(!selectedProducts.includes($option.val()));
                });
            }

            function updateProductData(selectElement) {
                const productoId = $(selectElement).val();
                if (productoId) {
                    $.ajax({
                        url: '{% url "app:obtener_datos_producto" %}',
                        data: { 'producto_id': productoId },
                        success: function(data) {
                            $(selectElement).closest('tr').find(".precio-unitario").val(data.precio);
                            updateTotals();
                        },
                        error: function() {
                            alert('Error al obtener los datos del producto.');
                        }
                    });
                }
            }

            $('#cliente_select').on('change', function() {
                const clienteId = $(this).val();
                if (clienteId) {
                    updateClientData(clienteId);
                }
            });

            $('#add-item').on('click', function() {
                const row = `
                    <tr>
                        <td>${$invoiceItems.find('tr').length + 1}</td>
                        <td>
                            <select class="form-control producto_select" name="producto">
                                <option value="" hidden>Seleccione un producto</option>
                                {% for producto in productos %}
                                    <option value="{{ producto.id }}">{{ producto.nombre }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="number" class="cantidad" value="1" min="1" step="1" required></td>
                        <td><input type="number" class="precio-unitario" value="0" min="0" step="1" required></td>
                        <td><input type="number" class="iva" value="19" min="0" max="100" step="1" required></td>
                        <td class="total">0.0</td>
                        <td class="acciones"><button type="button" class="delete-item">Eliminar</button></td>
                    </tr>
                `;
                $invoiceItems.append(row);
                updateProductOptions();

                $invoiceItems.off("change", ".producto_select").on("change", ".producto_select", function() {
                    updateProductData(this);
                });

                $invoiceItems.off("click", ".delete-item").on("click", ".delete-item", function() {
                    $(this).closest('tr').remove();
                    updateItemNumbers();
                    updateTotals();
                    updateProductOptions();
                });

                $invoiceItems.find(".cantidad, .precio-unitario, .iva").off("input").on("input", updateTotals);
            });

            $('#print-invoice').on('click', function() {
                const $accionesColumnas = $('th:last-child, td:last-child');
                $accionesColumnas.hide();
                window.print();
                $accionesColumnas.show();
            });
        });
    </script>
</body>

</html>