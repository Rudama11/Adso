{% extends 'listar.html' %}

{% load static %}

{% block contenido %}
<div class="card card-default">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-edit"></i> Editar Tipo de Producto
        </h3>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'app:tipo_editarTP' object.id %}" id="updateForm">
            {% csrf_token %}
            <div id="alert-container"></div>
            <div class="form-group">
                <label for="nombre">Nombre</label>
                <input type="text" class="form-control" id="nombre" name="nombre" value="{{ form.nombre.value }}" autocomplete="off">
                <div class="invalid-feedback" id="error-nombre"></div>
            </div>
            <div class="form-group">
                <label for="descripcion">Descripción</label>
                <input type="text" class="form-control" id="descripcion" name="descripcion" value="{{ form.descripcion.value }}" autocomplete="off">
                <div class="invalid-feedback" id="error-descripcion"></div>
            </div>
            <div class="card-footer">
                <button type="button" class="btn btn-success" id="confirmButton">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
                <a href="{% url 'app:tipo_listar' %}" class="btn btn-info btn-flat" style="background-color: #b82b2b; color: white;">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'node_modules/sweetalert2/sweetalert2.all.min.js' %}"></script>
<script>
    document.getElementById('confirmButton').addEventListener('click', function(e) {
        e.preventDefault();

        // Validación del lado del cliente
        let nombreField = document.getElementById('nombre');
        let descripcionField = document.getElementById('descripcion');

        if (!nombreField.value.trim()) {
            Swal.fire({
                title: 'Campo Obligatorio',
                text: 'El campo de nombre es obligatorio.',
                icon: 'warning',
                timer: 2000,
                timerProgressBar: true,
                confirmButtonText: 'Aceptar',
            });
            nombreField.focus();
            return;
        }

        if (!descripcionField.value.trim()) {
            Swal.fire({
                title: 'Campo Obligatorio',
                text: 'El campo de descripción es obligatorio.',
                icon: 'warning',
                timer: 2000,
                timerProgressBar: true,
                confirmButtonText: 'Aceptar',
            });
            descripcionField.focus();
            return;
        }

        // Obtener los datos del formulario
        let formData = new FormData(document.getElementById('updateForm'));

        // Enviar los datos mediante AJAX
        fetch(document.getElementById('updateForm').action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    title: 'Actualizado Correctamente',
                    text: 'Tipo de producto ha sido actualizado exitosamente.',
                    icon: 'success',
                    confirmButtonText: 'Continuar',
                    timer: 2000,
                    timerProgressBar: true,
                }).then(() => {
                    window.location.href = "{% url 'app:tipo_listar' %}";
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: data.message || 'Ha ocurrido un error al intentar actualizar el tipo de producto.',
                    icon: 'error',
                    confirmButtonText: 'Aceptar',
                });

                // Mostrar los errores específicos del formulario
                if (data.errors) {
                    Object.keys(data.errors).forEach(function(key) {
                        let field = document.getElementById(key);
                        if (field) {
                            field.classList.add('is-invalid');
                            let errorDiv = document.getElementById('error-' + key);
                            if (errorDiv) {
                                errorDiv.innerHTML = data.errors[key][0].message;
                            }
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>
{% endblock %}
