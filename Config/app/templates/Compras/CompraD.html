{% extends 'listar.html' %}
{% load static %}
{% load widget_tweaks %}

{% block contenido %}
<div class="container-fluid">
    <div class="card card-default mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-eye"></i>
                {{ titulo }}
            </h3>
        </div>
        <div class="card-body">
            <form id="formCompra" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_compra">ID de la Compra</label>
                    <input type="text" id="id_compra" class="form-control" value="{{ compra.id }}" readonly>
                </div>

                <div class="form-group">
                    <label for="id_num_factura">{{ form.num_factura.label }}</label>
                    {{ form.num_factura|add_class:'form-control'|attr:'readonly:readonly' }}
                </div>

                <div class="form-group">
                    <label for="id_fecha_compra">{{ form.fecha_compra.label }}</label>
                    <input type="text" class="form-control" id="id_fecha_compra" 
                        value="{{ form.fecha_compra.value|date:'d-m-Y' }}" readonly>
                </div>

                <div class="form-group">
                    <label for="id_proveedor">{{ form.proveedor.label }}</label>
                    {{ form.proveedor|add_class:'form-control'|attr:'disabled:disabled' }}
                </div>
            </form>
        </div>
    </div>

    <!-- Separador visual -->
    <hr>

    <!-- Sección de Detalles de Compra -->
    <div class="card card-default mb-4">
        <div class="card-header">
            <h4 class="card-title"><i class="fas fa-box"></i> Detalles de Compra</h4>
        </div>
        <div class="card-body">
            <form method="POST" id="detalle-compra-form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="id_producto">Producto</label>
                    <select id="id_producto" name="producto" class="form-control">
                        <option value="">Seleccione un producto</option>
                        {% for producto in productos %}
                            <option value="{{ producto.id }}">{{ producto.nombre }}</option>  <!-- Usa 'nombre' directamente -->
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="id_cantidad">Cantidad</label>
                    <input type="number" id="id_cantidad" name="cantidad" class="form-control" min="0" value="0" onchange="calcularTotal();">
                </div>

                <div class="form-group">
                    <label for="id_precio">Precio Unitario</label>
                    <input type="number" id="id_precio" name="precio_unitario" class="form-control" step="0.01" min="0" required onchange="calcularTotal();">
                </div>

                <div class="form-group">
                    <label for="id_iva">IVA (%)</label>
                    <input type="number" id="id_iva" name="iva" class="form-control"  value="19" onchange="calcularTotal();">
                </div>

                <div class="form-group">
                    <label for="id_total">Total</label>
                    <input type="number" id="id_total" name="total" class="form-control" readonly>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>IVA</th>
                            <th>Total</th>
                            <th>Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for detalle in detalles_compra %}
                            <tr>
                                <td>{{ detalle.producto }}</td>
                                <td>{{ detalle.cantidad }}</td>
                                <td>{{ detalle.precio_unitario }}</td>
                                <td>{{ detalle.iva }}%</td>
                                <td>{{ detalle.total }}</td>
                                <td>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6">No hay productos agregados.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card-footer">
        <button type="button" class="btn btn-primary" onclick="agregarDetalle();">
            <i class="fas fa-plus"></i> Agregar producto 
        </button>
        <button type="button" class="btn btn-success" onclick="window.print();">
            <i class="fas fa-print"></i> Imprimir Factura
        </button>
        <a href="{{ listar_url }}" class="btn btn-danger custom-btn print-hidden">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</div>

<script>
    const csrftoken = '{{ csrf_token }}';  // El token CSRF
    const compraId = '{{ compra.id }}';  // El ID de la compra
    const detalleCompraUrl = '{% url "app:detalle_compra" compra.id %}';  // La URL del endpoint

    function calcularTotal() {
        const cantidad = parseFloat(document.getElementById('id_cantidad').value) || 0;
        const precioUnitario = parseFloat(document.getElementById('id_precio').value) || 0;
        const iva = parseFloat(document.getElementById('id_iva').value) || 0;

        const total = (cantidad * precioUnitario) * (1 + (iva / 100));
        document.getElementById('id_total').value = total.toFixed(2);
    }

    document.getElementById('id_cantidad').addEventListener('change', calcularTotal);
    document.getElementById('id_precio').addEventListener('change', calcularTotal);
    document.getElementById('id_iva').addEventListener('change', calcularTotal);

    function agregarDetalle() {
        const productoId = document.getElementById('id_producto').value;
        const cantidad = parseFloat(document.getElementById('id_cantidad').value);
        const precio = parseFloat(document.getElementById('id_precio').value);
        const iva = parseFloat(document.getElementById('id_iva').value);
        const numFactura = document.getElementById('id_num_factura').value;
    
        // Validación de campos
        const missingFields = [];
        if (!productoId) missingFields.push('producto');
        if (!cantidad || isNaN(cantidad) || cantidad <= 0) missingFields.push('cantidad válida');
        if (!precio || isNaN(precio) || precio <= 0) missingFields.push('precio válido');
        if (!iva || isNaN(iva) || iva < 0) missingFields.push('IVA válido');
        if (!numFactura) missingFields.push('número de factura');
    
        if (missingFields.length > 0) {
            alert(`Faltan los siguientes datos: ${missingFields.join(', ')}`);
            return;
        }
    
        // Datos que se enviarán al servidor
        const formData = {
            producto: productoId,
            cantidad: cantidad,
            precio_unitario: precio,
            iva: iva,
            compra_id: compraId,  // Usamos el ID de la compra desde el contexto de la vista
            num_factura: numFactura
        };
    
        // Enviar la solicitud mediante fetch
        fetch(detalleCompraUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken  // Agrega el token CSRF para autenticación
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error inesperado en la respuesta del servidor.');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                location.reload();  // Recargar la página para mostrar los cambios
            } else {
                alert(`Error: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error en la solicitud:', error);
            alert('Error inesperado en la solicitud. Por favor, intenta de nuevo.');
        });
    }

</script>


<style>
    .card-footer .btn {
        margin: 5px 0;
        flex: 1 1 30%;
    }

    @media (max-width: 768px) {
        .table th, .table td {
            font-size: 14px;
        }
        .card-footer .btn {
            flex: 1 1 100%;
        }
    }

    .table thead th {
        background-color: #58697b; /* Color de fondo azul */
        color: white; /* Color del texto en blanco */
    }

    /* Estilo para las celdas de la tabla */
    .table tbody td {
        background-color: #f2f2f2; /* Color de fondo gris claro */
    }

    /* Estilo para las filas de la tabla al pasar el mouse */
    .table tbody tr:hover {
        background-color: #e0e0e0; /* Color de fondo gris más oscuro al pasar el mouse */
    }
</style>

{% endblock %}